---
title: "Blog"
execute:
  freeze: false
format:
  html:
    include-in-header:
      text: |
        <style>
          body {
            background: #0F2143;
            color: #ffffff;
          }
          h1, h2, h3, h4, h5, h6,
          .meta,
          .page-subtitle {
            color: #ffffff;
          }
          .blog-post-list li {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.25);
          }
          .blog-post-list a,
          .blog-post-list a:visited {
            color: #ffffff;
            text-decoration: underline;
          }
          .blog-post-list a:hover,
          .blog-post-list a:focus-visible {
            color: #dbe8ff;
            text-decoration: underline;
          }
          .blog-summary {
            color: #D4D4D4;
            font-size: 0.75rem;
          }
        </style>
---

```{r}
#| echo: false
#| warning: false
#| message: false
#| results: asis

post_files <- c(
  list.files("content/post", pattern = "\\.Rmd$", full.names = TRUE),
  list.files("content/post", pattern = "\\.qmd$", full.names = TRUE),
  list.files("content/post", pattern = "index\\.md$", recursive = TRUE, full.names = TRUE)
)

post_files <- post_files[!grepl("/_index\\.md$", post_files)]
post_files <- unique(post_files)

trim <- function(x) gsub("^\\s+|\\s+$", "", x)

get_front_matter <- function(path) {
  lines <- readLines(path, warn = FALSE)
  d <- which(trim(lines) == "---")
  if (length(d) < 2) return(character(0))
  lines[(d[1] + 1):(d[2] - 1)]
}

extract_field <- function(front, field) {
  if (!length(front)) return(NA_character_)
  m <- grep(paste0("^", field, ":"), front)
  if (!length(m)) return(NA_character_)
  v <- sub(paste0("^", field, ":\\s*"), "", front[m[1]])
  v <- gsub('^"|"$', "", trim(v))
  if (!nzchar(v)) return(NA_character_)
  v
}

first_non_empty <- function(values) {
  for (v in values) {
    if (!is.na(v) && nzchar(trim(v))) return(trim(v))
  }
  NA_character_
}

extract_body_text <- function(path) {
  lines <- readLines(path, warn = FALSE)
  d <- which(trim(lines) == "---")
  if (length(d) >= 2) {
    lines <- lines[(d[2] + 1):length(lines)]
  }

  # Drop fenced code blocks before estimating reading time/summary text.
  keep <- rep(TRUE, length(lines))
  in_fence <- FALSE
  for (i in seq_along(lines)) {
    line <- lines[i]
    if (grepl("^\\s*```", line)) {
      keep[i] <- FALSE
      in_fence <- !in_fence
      next
    }
    if (in_fence) keep[i] <- FALSE
  }

  text <- paste(lines[keep], collapse = " ")
  text <- gsub("<[^>]+>", " ", text)
  text <- gsub("!\\[[^\\]]*\\]\\([^\\)]*\\)", " ", text)
  text <- gsub("\\[([^\\]]+)\\]\\([^\\)]*\\)", "\\1", text)
  text <- gsub("[#>*_`~\\[\\]\\(\\)\\{\\}]", " ", text)
  text <- gsub("\\s+", " ", text)
  trim(text)
}

make_excerpt <- function(text, n_words = 38) {
  if (is.na(text) || !nzchar(text)) return("Summary unavailable.")
  parts <- unlist(strsplit(text, "\\s+"))
  parts <- parts[nzchar(parts)]
  if (!length(parts)) return("Summary unavailable.")
  if (length(parts) <= n_words) return(paste(parts, collapse = " "))
  paste(paste(parts[1:n_words], collapse = " "), "...")
}

estimate_read_minutes <- function(text, wpm = 220) {
  if (is.na(text) || !nzchar(text)) return(1L)
  words <- unlist(strsplit(text, "\\s+"))
  words <- words[nzchar(words)]
  max(1L, as.integer(ceiling(length(words) / wpm)))
}

post_slug <- function(path) {
  rel <- sub("^content/post/", "", path)
  rel <- gsub("\\\\", "/", rel)
  if (grepl("index\\.md$", rel)) {
    return(sub("/index\\.md$", "", rel))
  }
  base <- sub("\\.(Rmd|qmd)$", "", basename(rel))
  base
}

strip_front_matter <- function(lines) {
  d <- which(trim(lines) == "---")
  if (length(d) >= 2 && d[1] == 1) {
    lines <- lines[(d[2] + 1):length(lines)]
  }
  lines
}

copy_support_dir <- function(src_dir, dst_dir) {
  if (!dir.exists(src_dir)) return(invisible(NULL))
  files <- list.files(src_dir, full.names = TRUE, recursive = TRUE, all.files = FALSE, no.. = TRUE)
  if (!length(files)) return(invisible(NULL))
  src_norm <- gsub("\\\\", "/", src_dir)
  for (f in files) {
    f_norm <- gsub("\\\\", "/", f)
    rel <- substring(f_norm, nchar(src_norm) + 2)
    out <- file.path(dst_dir, rel)
    dir.create(dirname(out), recursive = TRUE, showWarnings = FALSE)
    file.copy(f, out, overwrite = TRUE)
  }
}

html_escape <- function(x) {
  if (is.na(x)) return("")
  x <- gsub("&", "&amp;", x, fixed = TRUE)
  x <- gsub("<", "&lt;", x, fixed = TRUE)
  x <- gsub(">", "&gt;", x, fixed = TRUE)
  x <- gsub("\"", "&quot;", x, fixed = TRUE)
  x
}

extract_html_body <- function(html_text) {
  if (grepl("<body[^>]*>", html_text, ignore.case = TRUE)) {
    html_text <- sub(".*<body[^>]*>", "", html_text, ignore.case = TRUE)
    html_text <- sub("</body>.*", "", html_text, ignore.case = TRUE)
  }
  trim(html_text)
}

normalize_body_html <- function(body_html) {
  if (is.na(body_html) || !nzchar(trim(body_html))) return("<p>Content unavailable.</p>")
  body_html <- gsub("<h1 class=\"title\">.*?</h1>", "", body_html, perl = TRUE)
  body_html <- gsub(
    "href=\"([^\"]+@[^\"]+)\"",
    "href=\"mailto:\\1\"",
    body_html,
    perl = TRUE
  )
  body_html
}

wrap_post_page <- function(body_html, title, date, read_mins) {
  t <- html_escape(ifelse(is.na(title), "Post", title))
  d <- ifelse(is.na(date) || !nzchar(trim(date)), "Date unavailable", date)
  m <- paste0(read_mins, " min read")
  b <- normalize_body_html(body_html)
  c(
    "<!DOCTYPE html>",
    "<html lang=\"en\">",
    "<head>",
    "<meta charset=\"utf-8\">",
    "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">",
    paste0("<title>", t, " | Francisco Rowe</title>"),
    "<style>",
    "body{font-family:\"Open Sans\",-apple-system,BlinkMacSystemFont,\"Segoe UI\",sans-serif;background:#f5f5f7;color:#1d1d1f;margin:0;line-height:1.65}",
    ".post-wrap{max-width:900px;margin:2rem auto;padding:0 1rem}",
    ".post-card{background:#fff;border:1px solid #d2d2d7;border-radius:18px;padding:1.1rem 1.2rem}",
    ".post-back{display:inline-block;margin-bottom:.9rem;color:#023E8A;text-decoration:underline;box-shadow:none;font-weight:700}",
    ".post-back:hover{color:#012f68;text-decoration:underline}",
    "h1{margin:0 0 .35rem;font-size:clamp(1.7rem,4vw,2.6rem);line-height:1.15}",
    ".post-meta{color:#6e6e73;font-size:.95rem;margin-bottom:1rem}",
    "img{max-width:100%;height:auto;border-radius:10px}",
    "pre{overflow:auto;background:#f6f8fa;border:1px solid #e5e7eb;border-radius:10px;padding:.75rem}",
    "blockquote{border-left:3px solid #d2d2d7;padding:.2rem .9rem;margin:1rem 0;color:#2f3b48;background:#fafbfc}",
    "a{color:#023E8A;text-decoration:underline;box-shadow:none;font-weight:700}",
    "a:hover{color:#012f68;text-decoration:underline}",
    "</style>",
    "</head>",
    "<body>",
    "<main class=\"post-wrap\">",
    "<article class=\"post-card\">",
    "<a class=\"post-back\" href=\"../../blog.html\">Back to Blog</a>",
    paste0("<h1>", t, "</h1>"),
    paste0("<div class=\"post-meta\">", d, " • ", m, "</div>"),
    b,
    "</article>",
    "</main>",
    "</body>",
    "</html>"
  )
}

write_html_copy <- function(html_src, out_file, out_dir, title, date, read_mins) {
  lines <- readLines(html_src, warn = FALSE, encoding = "UTF-8")
  lines <- strip_front_matter(lines)
  body_html <- extract_html_body(paste(lines, collapse = "\n"))
  page <- wrap_post_page(body_html, title, date, read_mins)
  writeLines(page, out_file, useBytes = TRUE)

  sidecar <- sub("\\.html$", "_files", html_src)
  if (dir.exists(sidecar)) {
    copy_support_dir(sidecar, file.path(out_dir, basename(sidecar)))
  }
}

render_markdown_post <- function(md_src, out_file, title = NA_character_, date = NA_character_, read_mins = 1L) {
  if (!requireNamespace("commonmark", quietly = TRUE)) return(FALSE)
  lines <- readLines(md_src, warn = FALSE, encoding = "UTF-8")
  lines <- strip_front_matter(lines)
  md_text <- paste(lines, collapse = "\n")
  body <- commonmark::markdown_html(md_text)
  page <- wrap_post_page(body, title, date, read_mins)
  writeLines(page, out_file, useBytes = TRUE)
  file.exists(out_file)
}

publish_post <- function(path, title, slug, date, read_mins) {
  out_dir <- file.path("_site", "post", slug)
  out_file <- file.path(out_dir, "index.html")
  dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
  ext <- tolower(tools::file_ext(path))

  if (ext %in% c("rmd", "qmd")) {
    html_src <- if (ext == "rmd") sub("\\.[Rr]md$", ".html", path) else sub("\\.[Qq]md$", ".html", path)
    if (file.exists(html_src)) {
      write_html_copy(html_src, out_file, out_dir, title, date, read_mins)
      return(file.exists(out_file))
    }
    return(render_markdown_post(path, out_file, title, date, read_mins))
  }

  if (basename(path) == "index.md") {
    copy_support_dir(dirname(path), out_dir)
    return(render_markdown_post(path, out_file, title, date, read_mins))
  }

  FALSE
}

posts <- lapply(post_files, function(path) {
  front <- get_front_matter(path)
  title <- extract_field(front, "title")
  date <- extract_field(front, "date")
  summary <- first_non_empty(c(
    extract_field(front, "summary"),
    extract_field(front, "subtitle"),
    extract_field(front, "description")
  ))
  body_text <- extract_body_text(path)
  if (is.na(title)) {
    title <- tools::file_path_sans_ext(basename(path))
  }
  if (is.na(summary)) {
    summary <- make_excerpt(body_text)
  }
  date_clean <- ifelse(is.na(date), NA_character_, substr(gsub("'", "", date), 1, 10))
  read_mins <- estimate_read_minutes(body_text)
  slug <- post_slug(path)
  data.frame(
    title = title,
    date = date_clean,
    slug = slug,
    source_path = path,
    summary = summary,
    read_mins = read_mins,
    stringsAsFactors = FALSE
  )
})

posts <- do.call(rbind, posts)
posts <- posts[!duplicated(posts$slug), ]
title_clean <- trimws(posts$title)
posts <- posts[nzchar(title_clean) & tolower(title_clean) != "untitled", ]
published <- vapply(
  seq_len(nrow(posts)),
  function(i) publish_post(posts$source_path[i], posts$title[i], posts$slug[i], posts$date[i], posts$read_mins[i]),
  logical(1)
)
posts <- posts[published, ]
posts$link <- paste0("./post/", posts$slug, "/index.html")
posts$date_sort <- as.Date(posts$date)
posts <- posts[order(posts$date_sort, decreasing = TRUE, na.last = TRUE), ]

if (nrow(posts) == 0) {
  cat("No posts found.\n")
} else {
  cat("<ul class=\"blog-post-list\">\n")
  for (i in seq_len(nrow(posts))) {
    d <- ifelse(is.na(posts$date[i]), "Date unavailable", posts$date[i])
    m <- paste0(posts$read_mins[i], " min read")
    cat("<li><strong><a href=\"", posts$link[i], "\">", posts$title[i], "</a></strong><br>", sep = "")
    cat("<span class=\"meta\">", d, " • ", m, "</span>", sep = "")
    cat("<p class=\"blog-summary\">", posts$summary[i], "</p>", sep = "")
    cat("</li>\n", sep = "")
  }
  cat("</ul>\n")
}
```
